<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Notes for Grad Student Orientation 2018</title>
  <meta name="description" content="Notes for Grad Student Orientation 2018">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Notes for Grad Student Orientation 2018" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="cjgeyer/Orientation2018/docs" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Notes for Grad Student Orientation 2018" />
  
  
  

<meta name="author" content="Charles J. Geyer">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="r-markdown.html">
<link rel="next" href="version-control-with-git.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i><b>1.1</b> License</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#r"><i class="fa fa-check"></i><b>1.2</b> R</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#other-learning-materials"><i class="fa fa-check"></i><b>1.3</b> Other Learning Materials</a><ul>
<li class="chapter" data-level="1.3.1" data-path="index.html"><a href="index.html#an-introduction-to-r"><i class="fa fa-check"></i><b>1.3.1</b> An Introduction to R</a></li>
<li class="chapter" data-level="1.3.2" data-path="index.html"><a href="index.html#an-r-short-course"><i class="fa fa-check"></i><b>1.3.2</b> An R Short Course</a></li>
<li class="chapter" data-level="1.3.3" data-path="index.html"><a href="index.html#an-r-course-undergraduate"><i class="fa fa-check"></i><b>1.3.3</b> An R Course (Undergraduate)</a></li>
<li class="chapter" data-level="1.3.4" data-path="index.html"><a href="index.html#an-r-course-phd-level"><i class="fa fa-check"></i><b>1.3.4</b> An R Course (PhD Level)</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="r-markdown.html"><a href="r-markdown.html"><i class="fa fa-check"></i><b>2</b> R Markdown</a><ul>
<li class="chapter" data-level="2.1" data-path="r-markdown.html"><a href="r-markdown.html#source"><i class="fa fa-check"></i><b>2.1</b> Source</a></li>
<li class="chapter" data-level="2.2" data-path="r-markdown.html"><a href="r-markdown.html#what-is-it-and-why-do-i-want-it"><i class="fa fa-check"></i><b>2.2</b> What is It, and Why do I Want It?</a><ul>
<li class="chapter" data-level="2.2.1" data-path="r-markdown.html"><a href="r-markdown.html#what-is-it"><i class="fa fa-check"></i><b>2.2.1</b> What is It?</a></li>
<li class="chapter" data-level="2.2.2" data-path="r-markdown.html"><a href="r-markdown.html#newbie-data-analysis"><i class="fa fa-check"></i><b>2.2.2</b> Newbie Data Analysis</a></li>
<li class="chapter" data-level="2.2.3" data-path="r-markdown.html"><a href="r-markdown.html#expert-data-analysis"><i class="fa fa-check"></i><b>2.2.3</b> Expert Data Analysis</a></li>
<li class="chapter" data-level="2.2.4" data-path="r-markdown.html"><a href="r-markdown.html#no-snarf-and-barf"><i class="fa fa-check"></i><b>2.2.4</b> No Snarf and Barf</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="r-markdown.html"><a href="r-markdown.html#getting-started"><i class="fa fa-check"></i><b>2.3</b> Getting Started</a></li>
<li class="chapter" data-level="2.4" data-path="r-markdown.html"><a href="r-markdown.html#syntax-not-involving-r"><i class="fa fa-check"></i><b>2.4</b> Syntax not Involving R</a></li>
<li class="chapter" data-level="2.5" data-path="r-markdown.html"><a href="r-markdown.html#syntax-involving-r"><i class="fa fa-check"></i><b>2.5</b> Syntax Involving R</a><ul>
<li class="chapter" data-level="2.5.1" data-path="r-markdown.html"><a href="r-markdown.html#code-chunks"><i class="fa fa-check"></i><b>2.5.1</b> Code Chunks</a></li>
<li class="chapter" data-level="2.5.2" data-path="r-markdown.html"><a href="r-markdown.html#plots"><i class="fa fa-check"></i><b>2.5.2</b> Plots</a></li>
<li class="chapter" data-level="2.5.3" data-path="r-markdown.html"><a href="r-markdown.html#tables"><i class="fa fa-check"></i><b>2.5.3</b> Tables</a></li>
<li class="chapter" data-level="2.5.4" data-path="r-markdown.html"><a href="r-markdown.html#in-line-r"><i class="fa fa-check"></i><b>2.5.4</b> In-Line R</a></li>
<li class="chapter" data-level="2.5.5" data-path="r-markdown.html"><a href="r-markdown.html#r-chunk-options"><i class="fa fa-check"></i><b>2.5.5</b> R Chunk Options</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html"><i class="fa fa-check"></i><b>3</b> Parallel Computing in R</a><ul>
<li class="chapter" data-level="3.1" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#r-markdown-source"><i class="fa fa-check"></i><b>3.1</b> R Markdown Source</a></li>
<li class="chapter" data-level="3.2" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#introduction-1"><i class="fa fa-check"></i><b>3.2</b> Introduction</a></li>
<li class="chapter" data-level="3.3" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#set-up"><i class="fa fa-check"></i><b>3.3</b> Set-Up</a></li>
<li class="chapter" data-level="3.4" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#doing-the-simulation-without-parallelization"><i class="fa fa-check"></i><b>3.4</b> Doing the Simulation without Parallelization</a><ul>
<li class="chapter" data-level="3.4.1" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#try-it"><i class="fa fa-check"></i><b>3.4.1</b> Try It</a></li>
<li class="chapter" data-level="3.4.2" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#check-it"><i class="fa fa-check"></i><b>3.4.2</b> Check It</a></li>
<li class="chapter" data-level="3.4.3" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#time-it"><i class="fa fa-check"></i><b>3.4.3</b> Time It</a></li>
<li class="chapter" data-level="3.4.4" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#time-it-more-accurately"><i class="fa fa-check"></i><b>3.4.4</b> Time It More Accurately</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#parallel-computing-with-unix-fork-and-exec"><i class="fa fa-check"></i><b>3.5</b> Parallel Computing With Unix Fork and Exec</a><ul>
<li class="chapter" data-level="3.5.1" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#introduction-2"><i class="fa fa-check"></i><b>3.5.1</b> Introduction</a></li>
<li class="chapter" data-level="3.5.2" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#toy-problem"><i class="fa fa-check"></i><b>3.5.2</b> Toy Problem</a></li>
<li class="chapter" data-level="3.5.3" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#parallel-streams-of-random-numbers"><i class="fa fa-check"></i><b>3.5.3</b> Parallel Streams of Random Numbers</a></li>
<li class="chapter" data-level="3.5.4" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#fork-example"><i class="fa fa-check"></i><b>3.5.4</b> The Example</a></li>
<li class="chapter" data-level="3.5.5" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#fork-try"><i class="fa fa-check"></i><b>3.5.5</b> Try It</a></li>
<li class="chapter" data-level="3.5.6" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#fork-check"><i class="fa fa-check"></i><b>3.5.6</b> Check It</a></li>
<li class="chapter" data-level="3.5.7" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#fork-time"><i class="fa fa-check"></i><b>3.5.7</b> Time It</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#the-example-with-a-cluster"><i class="fa fa-check"></i><b>3.6</b> The Example With a Cluster</a><ul>
<li class="chapter" data-level="3.6.1" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#introduction-3"><i class="fa fa-check"></i><b>3.6.1</b> Introduction</a></li>
<li class="chapter" data-level="3.6.2" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#toy-problem-1"><i class="fa fa-check"></i><b>3.6.2</b> Toy Problem</a></li>
<li class="chapter" data-level="3.6.3" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#rng-cluster"><i class="fa fa-check"></i><b>3.6.3</b> Parallel Streams of Random Numbers</a></li>
<li class="chapter" data-level="3.6.4" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#the-example-on-a-cluster"><i class="fa fa-check"></i><b>3.6.4</b> The Example on a Cluster</a></li>
<li class="chapter" data-level="3.6.5" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#tear-down"><i class="fa fa-check"></i><b>3.6.5</b> Tear Down</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#latis"><i class="fa fa-check"></i><b>3.7</b> LATIS</a><ul>
<li class="chapter" data-level="3.7.1" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#fork-exec-in-interactive-session"><i class="fa fa-check"></i><b>3.7.1</b> Fork-Exec in Interactive Session</a></li>
<li class="chapter" data-level="3.7.2" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#cluster-in-interactive-session"><i class="fa fa-check"></i><b>3.7.2</b> Cluster in Interactive Session</a></li>
<li class="chapter" data-level="3.7.3" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#fork-exec-as-batch-job"><i class="fa fa-check"></i><b>3.7.3</b> Fork-Exec as Batch Job</a></li>
<li class="chapter" data-level="3.7.4" data-path="parallel-computing-in-r.html"><a href="parallel-computing-in-r.html#cluster-as-batch-job"><i class="fa fa-check"></i><b>3.7.4</b> Cluster as Batch Job</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="version-control-with-git.html"><a href="version-control-with-git.html"><i class="fa fa-check"></i><b>4</b> Version Control with Git</a><ul>
<li class="chapter" data-level="4.1" data-path="version-control-with-git.html"><a href="version-control-with-git.html#reading"><i class="fa fa-check"></i><b>4.1</b> Reading</a></li>
<li class="chapter" data-level="4.2" data-path="version-control-with-git.html"><a href="version-control-with-git.html#git-command-line"><i class="fa fa-check"></i><b>4.2</b> Git Command Line</a></li>
<li class="chapter" data-level="4.3" data-path="version-control-with-git.html"><a href="version-control-with-git.html#git-from-rstudio"><i class="fa fa-check"></i><b>4.3</b> Git from RStudio</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Notes for Grad Student Orientation 2018</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="parallel-computing-in-r" class="section level1">
<h1><span class="header-section-number"> 3</span> Parallel Computing in R</h1>
<div id="r-markdown-source" class="section level2">
<h2><span class="header-section-number">3.1</span> R Markdown Source</h2>
<p><a href="https://raw.githubusercontent.com/cjgeyer/Orientation2018/master/02-parallel.Rmd" class="uri">https://raw.githubusercontent.com/cjgeyer/Orientation2018/master/02-parallel.Rmd</a></p>
</div>
<div id="introduction-1" class="section level2">
<h2><span class="header-section-number">3.2</span> Introduction</h2>
<p>The example that we will use throughout this document is simulating the sampling distribution of the MLE for <span class="math inline">\(\text{Normal}(\theta, \theta^2)\)</span> data.</p>
<p>A lot of this may make make no sense. This is what you are going to graduate school in statistics to learn. But we want a non-toy example.</p>
</div>
<div id="set-up" class="section level2">
<h2><span class="header-section-number">3.3</span> Set-Up</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># sample size</span>
n &lt;-<span class="st"> </span><span class="dv">10</span>
<span class="co"># simulation sample size</span>
nsim &lt;-<span class="st"> </span><span class="fl">1e4</span>
<span class="co"># true unknown parameter value</span>
<span class="co"># of course in the simulation it is known, but we pretend we don&#39;t</span>
<span class="co"># know it and estimate it</span>
theta &lt;-<span class="st"> </span><span class="dv">1</span>

doit &lt;-<span class="st"> </span><span class="cf">function</span>(estimator, <span class="dt">seed =</span> <span class="dv">42</span>) {
    <span class="kw">set.seed</span>(seed)
    result &lt;-<span class="st"> </span><span class="kw">double</span>(nsim)
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nsim) {
        x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n, theta, <span class="kw">abs</span>(theta))
        result[i] &lt;-<span class="st"> </span><span class="kw">estimator</span>(x)
    }
    <span class="kw">return</span>(result)
}

mlogl &lt;-<span class="st"> </span><span class="cf">function</span>(theta, x) <span class="kw">sum</span>(<span class="op">-</span><span class="st"> </span><span class="kw">dnorm</span>(x, theta, <span class="kw">abs</span>(theta), <span class="dt">log =</span> <span class="ot">TRUE</span>))

mle &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
    theta.start &lt;-<span class="st"> </span><span class="kw">sign</span>(<span class="kw">mean</span>(x)) <span class="op">*</span><span class="st"> </span><span class="kw">sd</span>(x)
    <span class="cf">if</span> (<span class="kw">all</span>(x <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">||</span><span class="st"> </span>theta.start <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)
        <span class="kw">return</span>(<span class="dv">0</span>)
    nout &lt;-<span class="st"> </span><span class="kw">nlm</span>(mlogl, theta.start, <span class="dt">iterlim =</span> <span class="dv">1000</span>, <span class="dt">x =</span> x)
    <span class="cf">if</span> (nout<span class="op">$</span>code <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>)
        <span class="kw">return</span>(<span class="ot">NaN</span>)
    <span class="kw">return</span>(nout<span class="op">$</span>estimate)
}</code></pre></div>
<ul>
<li><p>R function <code>doit</code> simulates <code>nsim</code> datasets, applies an estimator supplied as an argument to the function to each, and returns the vector of results.</p></li>
<li><p>R function <code>mlogl</code> is minus the log likelihood of the model in question. We could easily change the code to do another model by changing only this function. (When the code mimics the math, the design is usually good.)</p></li>
<li><p>R function <code>mle</code> calculates the estimator by calling R function <code>nlm</code> to minimize it. The starting value, either <code>sign(mean(x)) * sd(x)</code> is a reasonable estimator because <code>mean(x)</code> is a consistent estimator of <span class="math inline">\(\theta\)</span> and <code>sd(x)</code> is a consistent estimator of <span class="math inline">\(\lvert \theta \rvert\)</span>.</p></li>
</ul>
</div>
<div id="doing-the-simulation-without-parallelization" class="section level2">
<h2><span class="header-section-number">3.4</span> Doing the Simulation without Parallelization</h2>
<div id="try-it" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Try It</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">theta.hat &lt;-<span class="st"> </span><span class="kw">doit</span>(mle)</code></pre></div>
</div>
<div id="check-it" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Check It</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(theta.hat, <span class="dt">probability =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="dv">30</span>)
<span class="kw">curve</span>(<span class="kw">dnorm</span>(x, <span class="dt">mean =</span> theta, <span class="dt">sd =</span> theta <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">3</span> <span class="op">*</span><span class="st"> </span>n)), <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="02-parallel_files/figure-html/hist-non-par-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>The curve is the PDF of the asymptotic normal distribution of the MLE, which uses the formula <span class="math display">\[
   I_n(\theta) = \frac{3 n}{\theta^2}
\]</span> which you will learn how to calculate when you take a theory course (if you don’t already know).</p>
<p>Looks pretty good. The large negative estimates are probably not a mistake. The parameter is allowed to be negative, so sometimes the estimates come out negative even though the truth is positive. And not just a little negative because <span class="math inline">\(\lvert \theta \rvert\)</span> is also the standard deviation, so it cannot be small and the model fit the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(<span class="kw">is.na</span>(theta.hat))</code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">is.na</span>(theta.hat))</code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(theta.hat <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] 9</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(theta.hat <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] 9e-04</code></pre>
</div>
<div id="time-it" class="section level3">
<h3><span class="header-section-number">3.4.3</span> Time It</h3>
<p>Now for something new. We will time it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">time1 &lt;-<span class="st"> </span><span class="kw">system.time</span>(theta.hat.mle &lt;-<span class="st"> </span><span class="kw">doit</span>(mle))
time1</code></pre></div>
<pre><code>##    user  system elapsed 
##   0.985   0.000   0.985</code></pre>
</div>
<div id="time-it-more-accurately" class="section level3">
<h3><span class="header-section-number">3.4.4</span> Time It More Accurately</h3>
<p>That’s too short a time for accurate timing. Also we should probably average over several IID iterations to get a good average. Try again.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nsim &lt;-<span class="st"> </span><span class="fl">1e5</span>
nrep &lt;-<span class="st"> </span><span class="dv">7</span>
time1 &lt;-<span class="st"> </span><span class="ot">NULL</span>
<span class="cf">for</span> (irep <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nrep)
    time1 &lt;-<span class="st"> </span><span class="kw">rbind</span>(time1, <span class="kw">system.time</span>(theta.hat.mle &lt;-<span class="st"> </span><span class="kw">doit</span>(mle)))
time1</code></pre></div>
<pre><code>##      user.self sys.self elapsed user.child sys.child
## [1,]    10.112    0.000  10.123          0         0
## [2,]    10.175    0.001  10.158          0         0
## [3,]     9.746    0.000   9.726          0         0
## [4,]     9.963    0.000   9.945          0         0
## [5,]     9.665    0.000   9.651          0         0
## [6,]    10.000    0.000   9.987          0         0
## [7,]     9.517    0.000   9.505          0         0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time1, <span class="dv">2</span>, mean)</code></pre></div>
<pre><code>##    user.self     sys.self      elapsed   user.child    sys.child 
## 9.8825714286 0.0001428571 9.8707142857 0.0000000000 0.0000000000</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time1, <span class="dv">2</span>, sd) <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(nrep)</code></pre></div>
<pre><code>##    user.self     sys.self      elapsed   user.child    sys.child 
## 0.0923298582 0.0001428571 0.0936286266 0.0000000000 0.0000000000</code></pre>
</div>
</div>
<div id="parallel-computing-with-unix-fork-and-exec" class="section level2">
<h2><span class="header-section-number">3.5</span> Parallel Computing With Unix Fork and Exec</h2>
<div id="introduction-2" class="section level3">
<h3><span class="header-section-number">3.5.1</span> Introduction</h3>
<p>This method is by far the simplest but</p>
<ul>
<li><p>it only works on one computer (using however many simultaneous processes the computer can do), and</p></li>
<li><p>it does not work on Windows.</p></li>
</ul>
</div>
<div id="toy-problem" class="section level3">
<h3><span class="header-section-number">3.5.2</span> Toy Problem</h3>
<p>First a toy problem that does nothing except show that we are actually using different processes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(parallel)
ncores &lt;-<span class="st"> </span><span class="kw">detectCores</span>()
<span class="kw">mclapply</span>(<span class="dv">1</span><span class="op">:</span>ncores, <span class="cf">function</span>(x) <span class="kw">Sys.getpid</span>(), <span class="dt">mc.cores =</span> ncores)</code></pre></div>
<pre><code>## [[1]]
## [1] 17210
## 
## [[2]]
## [1] 17211
## 
## [[3]]
## [1] 17212
## 
## [[4]]
## [1] 17213
## 
## [[5]]
## [1] 17214
## 
## [[6]]
## [1] 17215
## 
## [[7]]
## [1] 17216
## 
## [[8]]
## [1] 17217</code></pre>
</div>
<div id="parallel-streams-of-random-numbers" class="section level3">
<h3><span class="header-section-number">3.5.3</span> Parallel Streams of Random Numbers</h3>
<p>To get random numbers in parallel, we need to use a special random number generator (RNG) designed for parallelization.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">RNGkind</span>(<span class="st">&quot;L&#39;Ecuyer-CMRG&quot;</span>)
<span class="kw">set.seed</span>(<span class="dv">42</span>)
<span class="kw">mclapply</span>(<span class="dv">1</span><span class="op">:</span>ncores, <span class="cf">function</span>(x) <span class="kw">rnorm</span>(<span class="dv">5</span>), <span class="dt">mc.cores =</span> ncores)</code></pre></div>
<pre><code>## [[1]]
## [1]  1.11932846 -0.07617141 -0.35021912 -0.33491161 -1.73311280
## 
## [[2]]
## [1] -0.2084809 -1.0341493 -0.2629060  0.3880115  0.8331067
## 
## [[3]]
## [1]  0.001100034  1.763058291 -0.166377859 -0.311947389  0.694879494
## 
## [[4]]
## [1]  0.2262605 -0.4827515  1.7637105 -0.1887217 -0.7998982
## 
## [[5]]
## [1]  0.8584220 -0.3851236  1.0817530  0.2851169  0.1799325
## 
## [[6]]
## [1] -1.1378621 -1.5197576 -0.9198612  1.0303683 -0.9458347
## 
## [[7]]
## [1] -0.04649149  3.38053730 -0.35705061  0.17722940 -0.39716405
## 
## [[8]]
## [1]  1.3502819 -1.0055894 -0.4591798 -0.0628527 -0.2706805</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">42</span>)
<span class="kw">mclapply</span>(<span class="dv">1</span><span class="op">:</span>ncores, <span class="cf">function</span>(x) <span class="kw">rnorm</span>(<span class="dv">5</span>), <span class="dt">mc.cores =</span> ncores)</code></pre></div>
<pre><code>## [[1]]
## [1]  1.11932846 -0.07617141 -0.35021912 -0.33491161 -1.73311280
## 
## [[2]]
## [1] -0.2084809 -1.0341493 -0.2629060  0.3880115  0.8331067
## 
## [[3]]
## [1]  0.001100034  1.763058291 -0.166377859 -0.311947389  0.694879494
## 
## [[4]]
## [1]  0.2262605 -0.4827515  1.7637105 -0.1887217 -0.7998982
## 
## [[5]]
## [1]  0.8584220 -0.3851236  1.0817530  0.2851169  0.1799325
## 
## [[6]]
## [1] -1.1378621 -1.5197576 -0.9198612  1.0303683 -0.9458347
## 
## [[7]]
## [1] -0.04649149  3.38053730 -0.35705061  0.17722940 -0.39716405
## 
## [[8]]
## [1]  1.3502819 -1.0055894 -0.4591798 -0.0628527 -0.2706805</code></pre>
<p>Just right! We have different random numbers in all our jobs. And it is reproducible.</p>
<p>But this may not work like you may think it does. If we do it again we get exactly the same results. Running <code>mclapply</code> does not change <code>.Random.seed</code> in the parent process (the R process you are typing into). It only changes it in the child processes (that do the work). But there is no communication from child to parent <em>except</em> the list of results returned by <code>mclapply</code>.</p>
<p>This is a fundamental problem with <code>mclapply</code> and the fork-exec method of parallelization. And it has no real solution. You just have to be aware of it.</p>
<p>If you want to do exactly the same random thing with <code>mclapply</code> and get different random results, then you must change <code>.Random.seed</code> in the parent process, either with <code>set.seed</code> or by otherwise using random numbers <em>in the parent process</em>.</p>
</div>
<div id="fork-example" class="section level3">
<h3><span class="header-section-number">3.5.4</span> The Example</h3>
<p>We need to rewrite our <code>doit</code> function</p>
<ul>
<li><p>to only do <code>1 / ncores</code> of the work in each child process,</p></li>
<li><p>to not set the random number generator seed, and</p></li>
<li><p>to take an argument in some list we provide.</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">doit &lt;-<span class="st"> </span><span class="cf">function</span>(nsim, estimator) {
    result &lt;-<span class="st"> </span><span class="kw">double</span>(nsim)
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nsim) {
        x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n, theta, <span class="kw">abs</span>(theta))
        result[i] &lt;-<span class="st"> </span><span class="kw">estimator</span>(x)
    }
    <span class="kw">return</span>(result)
}</code></pre></div>
</div>
<div id="fork-try" class="section level3">
<h3><span class="header-section-number">3.5.5</span> Try It</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mout &lt;-<span class="st"> </span><span class="kw">mclapply</span>(<span class="kw">rep</span>(nsim <span class="op">/</span><span class="st"> </span>ncores, ncores), doit,
    <span class="dt">estimator =</span> mle, <span class="dt">mc.cores =</span> ncores)
<span class="kw">lapply</span>(mout, head)</code></pre></div>
<pre><code>## [[1]]
## [1] 0.9051972 0.9589889 0.9799828 1.1347548 0.9090886 0.9821320
## 
## [[2]]
## [1] 0.8317815 1.3432331 0.7821308 1.2010078 0.9792244 1.1148521
## 
## [[3]]
## [1] 0.8627829 0.9790400 1.1787975 0.7852431 1.2942963 1.0768396
## 
## [[4]]
## [1] 1.0422013 0.9166641 0.8326720 1.1864809 0.9609456 1.3137716
## 
## [[5]]
## [1] 0.8057316 0.9488173 1.0792078 0.9774531 0.8106612 0.8403027
## 
## [[6]]
## [1] 1.0156983 1.0077599 0.9867766 1.1643493 0.9478923 1.1770221
## 
## [[7]]
## [1] 1.2287013 1.0046353 0.9560784 1.0354414 0.9045423 0.9455714
## 
## [[8]]
## [1] 0.7768910 1.0376265 0.8830854 0.8911714 1.0288567 1.1609360</code></pre>
</div>
<div id="fork-check" class="section level3">
<h3><span class="header-section-number">3.5.6</span> Check It</h3>
<p>Seems to have worked.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(mout)</code></pre></div>
<pre><code>## [1] 8</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sapply</span>(mout, length)</code></pre></div>
<pre><code>## [1] 12500 12500 12500 12500 12500 12500 12500 12500</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lapply</span>(mout, head)</code></pre></div>
<pre><code>## [[1]]
## [1] 0.9051972 0.9589889 0.9799828 1.1347548 0.9090886 0.9821320
## 
## [[2]]
## [1] 0.8317815 1.3432331 0.7821308 1.2010078 0.9792244 1.1148521
## 
## [[3]]
## [1] 0.8627829 0.9790400 1.1787975 0.7852431 1.2942963 1.0768396
## 
## [[4]]
## [1] 1.0422013 0.9166641 0.8326720 1.1864809 0.9609456 1.3137716
## 
## [[5]]
## [1] 0.8057316 0.9488173 1.0792078 0.9774531 0.8106612 0.8403027
## 
## [[6]]
## [1] 1.0156983 1.0077599 0.9867766 1.1643493 0.9478923 1.1770221
## 
## [[7]]
## [1] 1.2287013 1.0046353 0.9560784 1.0354414 0.9045423 0.9455714
## 
## [[8]]
## [1] 0.7768910 1.0376265 0.8830854 0.8911714 1.0288567 1.1609360</code></pre>
<p>Plot it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">theta.hat &lt;-<span class="st"> </span><span class="kw">unlist</span>(mout)
<span class="kw">hist</span>(theta.hat, <span class="dt">probability =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="dv">30</span>)
<span class="kw">curve</span>(<span class="kw">dnorm</span>(x, <span class="dt">mean =</span> theta, <span class="dt">sd =</span> theta <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">3</span> <span class="op">*</span><span class="st"> </span>n)), <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="02-parallel_files/figure-html/hist-fork-exec-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="fork-time" class="section level3">
<h3><span class="header-section-number">3.5.7</span> Time It</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">time4 &lt;-<span class="st"> </span><span class="ot">NULL</span>
<span class="cf">for</span> (irep <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nrep)
    time4 &lt;-<span class="st"> </span><span class="kw">rbind</span>(time4, <span class="kw">system.time</span>(theta.hat.mle &lt;-
<span class="st">        </span><span class="kw">unlist</span>(<span class="kw">mclapply</span>(<span class="kw">rep</span>(nsim <span class="op">/</span><span class="st"> </span>ncores, ncores), doit,
            <span class="dt">estimator =</span> mle, <span class="dt">mc.cores =</span> ncores))))
time4</code></pre></div>
<pre><code>##      user.self sys.self elapsed user.child sys.child
## [1,]     0.007    0.012   2.191     14.063     0.217
## [2,]     0.001    0.016   2.733     18.288     0.164
## [3,]     0.003    0.016   3.156     20.357     0.240
## [4,]     0.003    0.016   3.093     20.051     0.200
## [5,]     0.001    0.016   3.091     20.264     0.260
## [6,]     0.000    0.019   3.132     20.185     0.247
## [7,]     0.002    0.016   3.079     20.126     0.236</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time4, <span class="dv">2</span>, mean)</code></pre></div>
<pre><code>##    user.self     sys.self      elapsed   user.child    sys.child 
##  0.002428571  0.015857143  2.925000000 19.047714286  0.223428571</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time4, <span class="dv">2</span>, sd) <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(nrep)</code></pre></div>
<pre><code>##    user.self     sys.self      elapsed   user.child    sys.child 
## 0.0008689661 0.0007693093 0.1337486983 0.8739731857 0.0123901980</code></pre>
<p>We got the desired speedup. The elapsed time averages</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time4, <span class="dv">2</span>, mean)[<span class="st">&quot;elapsed&quot;</span>]</code></pre></div>
<pre><code>## elapsed 
##   2.925</code></pre>
<p>with parallelization and</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time1, <span class="dv">2</span>, mean)[<span class="st">&quot;elapsed&quot;</span>]</code></pre></div>
<pre><code>##  elapsed 
## 9.870714</code></pre>
<p>without parallelization. But we did not get an 8-fold speedup with 8 cores. There is a cost to starting and stopping the child processes. And some time needs to be taken from this number crunching to run the rest of the computer. However, we did get a 3.4-fold speedup. If we had more cores, we could do even better.</p>
</div>
</div>
<div id="the-example-with-a-cluster" class="section level2">
<h2><span class="header-section-number">3.6</span> The Example With a Cluster</h2>
<div id="introduction-3" class="section level3">
<h3><span class="header-section-number">3.6.1</span> Introduction</h3>
<p>This method is more complicated but</p>
<ul>
<li><p>it works on clusters like the ones at <a href="http://z.umn.edu/claresearchcomputing">LATIS (College of Liberal Arts Technologies and Innovation Services</a> or at the <a href="https://www.msi.umn.edu/">Minnesota Supercomputing Institute</a>.</p></li>
<li><p>according to the documentation, it does work on Windows.</p></li>
</ul>
</div>
<div id="toy-problem-1" class="section level3">
<h3><span class="header-section-number">3.6.2</span> Toy Problem</h3>
<p>First a toy problem that does nothing except show that we are actually using different processes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(parallel)
ncores &lt;-<span class="st"> </span><span class="kw">detectCores</span>()
cl &lt;-<span class="st"> </span><span class="kw">makePSOCKcluster</span>(ncores)
<span class="kw">parLapply</span>(cl, <span class="dv">1</span><span class="op">:</span>ncores, <span class="cf">function</span>(x) <span class="kw">Sys.getpid</span>())</code></pre></div>
<pre><code>## [[1]]
## [1] 17238
## 
## [[2]]
## [1] 17247
## 
## [[3]]
## [1] 17256
## 
## [[4]]
## [1] 17265
## 
## [[5]]
## [1] 17274
## 
## [[6]]
## [1] 17283
## 
## [[7]]
## [1] 17292
## 
## [[8]]
## [1] 17301</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">stopCluster</span>(cl)</code></pre></div>
<p>This is more complicated in that</p>
<ul>
<li><p>first you you set up a cluster, here with <code>makePSOCKcluster</code> but not everywhere — there are a variety of different commands to make clusters and the command would be different at LATIS or MSI — and</p></li>
<li><p>at the end you tear down the cluster with <code>stopCluster</code>.</p></li>
</ul>
<p>Of course, you do not need to tear down the cluster before you are done with it. You can execute multiple <code>parLapply</code> commands on the same cluster.</p>
<p>There are also a lot of other commands other than <code>parLapply</code> that can be used on the cluster. We will see some of them below.</p>
</div>
<div id="rng-cluster" class="section level3">
<h3><span class="header-section-number">3.6.3</span> Parallel Streams of Random Numbers</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cl &lt;-<span class="st"> </span><span class="kw">makePSOCKcluster</span>(ncores)
<span class="kw">clusterSetRNGStream</span>(cl, <span class="dv">42</span>)
<span class="kw">parLapply</span>(cl, <span class="dv">1</span><span class="op">:</span>ncores, <span class="cf">function</span>(x) <span class="kw">rnorm</span>(<span class="dv">5</span>))</code></pre></div>
<pre><code>## [[1]]
## [1] -0.93907708 -0.04167943  0.82941349 -0.43935820 -0.31403543
## 
## [[2]]
## [1]  1.11932846 -0.07617141 -0.35021912 -0.33491161 -1.73311280
## 
## [[3]]
## [1] -0.2084809 -1.0341493 -0.2629060  0.3880115  0.8331067
## 
## [[4]]
## [1]  0.001100034  1.763058291 -0.166377859 -0.311947389  0.694879494
## 
## [[5]]
## [1]  0.2262605 -0.4827515  1.7637105 -0.1887217 -0.7998982
## 
## [[6]]
## [1]  0.8584220 -0.3851236  1.0817530  0.2851169  0.1799325
## 
## [[7]]
## [1] -1.1378621 -1.5197576 -0.9198612  1.0303683 -0.9458347
## 
## [[8]]
## [1] -0.04649149  3.38053730 -0.35705061  0.17722940 -0.39716405</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">parLapply</span>(cl, <span class="dv">1</span><span class="op">:</span>ncores, <span class="cf">function</span>(x) <span class="kw">rnorm</span>(<span class="dv">5</span>))</code></pre></div>
<pre><code>## [[1]]
## [1] -2.1290236  2.5069224 -1.1273128  0.1660827  0.5767232
## 
## [[2]]
## [1] 0.03628534 0.29647473 1.07128138 0.72844380 0.12458507
## 
## [[3]]
## [1] -0.1652167 -0.3262253 -0.2657667  0.1878883  1.4916193
## 
## [[4]]
## [1]  0.3541931 -0.6820627 -1.0762411 -0.9595483  0.0982342
## 
## [[5]]
## [1]  0.5441483  1.0852866  1.6011037 -0.5018903 -0.2709106
## 
## [[6]]
## [1] -0.57445721 -0.86440961 -0.77401840  0.54423137 -0.01006838
## 
## [[7]]
## [1] -1.3057289  0.5911102  0.8416164  1.7477622 -0.7824792
## 
## [[8]]
## [1]  0.9071634  0.2518615 -0.4905999  0.4900700  0.7970189</code></pre>
<p>We see that clusters do not have the same problem with continuing random number streams that the fork-exec mechanism has.</p>
<ul>
<li><p>Using fork-exec there is a <em>parent</em> process and <em>child</em> processes (all running on the same computer) and the <em>child</em> processes end when their work is done (when <code>mclapply</code> finishes).</p></li>
<li><p>Using clusters there is a <em>master</em> process and <em>slave</em> processes (possibly running on many different computers) and the <em>slave</em> processes end when the cluster is torn down (with <code>stopCluster</code>).</p></li>
</ul>
<p>So the slave processes continue and remember where they are in the random number stream.</p>
</div>
<div id="the-example-on-a-cluster" class="section level3">
<h3><span class="header-section-number">3.6.4</span> The Example on a Cluster</h3>
<div id="cluster-setup" class="section level4">
<h4><span class="header-section-number">3.6.4.1</span> Set Up</h4>
<p>Another complication of using clusters is that the slave processes are completely independent of the master. Any information they have must be explicitly passed to them.</p>
<p>This is very unlike the fork-exec model in which all of the child processes are copies of the parent process inheriting all of its memory (and thus knowing about any and all R objects it created).</p>
<p>So in order for our example to work we must explicitly distribute stuff to the cluster.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">clusterExport</span>(cl, <span class="kw">c</span>(<span class="st">&quot;doit&quot;</span>, <span class="st">&quot;mle&quot;</span>, <span class="st">&quot;mlogl&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="st">&quot;nsim&quot;</span>, <span class="st">&quot;theta&quot;</span>))</code></pre></div>
<p>Now all of the slaves have those R objects, as copied from the master process right now. If we change them in the master (pedantically if we change the R objects those <em>names</em> refer to) the slaves won’t know about it. They only would make changes if code were executed on them to do so.</p>
</div>
<div id="cluster-try" class="section level4">
<h4><span class="header-section-number">3.6.4.2</span> Try It</h4>
<p>So now we are set up to try our example.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pout &lt;-<span class="st"> </span><span class="kw">parLapply</span>(cl, <span class="kw">rep</span>(nsim <span class="op">/</span><span class="st"> </span>ncores, ncores), doit, <span class="dt">estimator =</span> mle)</code></pre></div>
</div>
<div id="cluster-check" class="section level4">
<h4><span class="header-section-number">3.6.4.3</span> Check It</h4>
<p>Seems to have worked.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(pout)</code></pre></div>
<pre><code>## [1] 8</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sapply</span>(pout, length)</code></pre></div>
<pre><code>## [1] 12500 12500 12500 12500 12500 12500 12500 12500</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lapply</span>(pout, head)</code></pre></div>
<pre><code>## [[1]]
## [1] 1.0079313 0.7316543 0.4958322 0.7705943 0.7734226 0.6158992
## 
## [[2]]
## [1] 0.9589889 0.9799828 1.1347548 0.9090886 0.9821320 1.0032531
## 
## [[3]]
## [1] 1.3432331 0.7821308 1.2010078 0.9792244 1.1148521 0.9269000
## 
## [[4]]
## [1] 0.9790400 1.1787975 0.7852431 1.2942963 1.0768396 0.7546295
## 
## [[5]]
## [1] 0.9166641 0.8326720 1.1864809 0.9609456 1.3137716 0.9832663
## 
## [[6]]
## [1] 0.9488173 1.0792078 0.9774531 0.8106612 0.8403027 1.1296857
## 
## [[7]]
## [1] 1.0077599 0.9867766 1.1643493 0.9478923 1.1770221 1.2789464
## 
## [[8]]
## [1] 1.0046353 0.9560784 1.0354414 0.9045423 0.9455714 1.0312553</code></pre>
<p>Plot it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">theta.hat &lt;-<span class="st"> </span><span class="kw">unlist</span>(mout)
<span class="kw">hist</span>(theta.hat, <span class="dt">probability =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="dv">30</span>)
<span class="kw">curve</span>(<span class="kw">dnorm</span>(x, <span class="dt">mean =</span> theta, <span class="dt">sd =</span> theta <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">3</span> <span class="op">*</span><span class="st"> </span>n)), <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="02-parallel_files/figure-html/hist-cluster-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="cluster-time" class="section level4">
<h4><span class="header-section-number">3.6.4.4</span> Time It</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">time5 &lt;-<span class="st"> </span><span class="ot">NULL</span>
<span class="cf">for</span> (irep <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nrep)
    time5 &lt;-<span class="st"> </span><span class="kw">rbind</span>(time5, <span class="kw">system.time</span>(theta.hat.mle &lt;-
<span class="st">        </span><span class="kw">unlist</span>(<span class="kw">parLapply</span>(cl, <span class="kw">rep</span>(nsim <span class="op">/</span><span class="st"> </span>ncores, ncores),
            doit, <span class="dt">estimator =</span> mle))))
time5</code></pre></div>
<pre><code>##      user.self sys.self elapsed user.child sys.child
## [1,]     0.007    0.000   3.366          0         0
## [2,]     0.003    0.004   3.319          0         0
## [3,]     0.005    0.000   3.346          0         0
## [4,]     0.000    0.006   3.350          0         0
## [5,]     0.006    0.000   3.308          0         0
## [6,]     0.003    0.004   3.376          0         0
## [7,]     0.002    0.004   3.261          0         0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time5, <span class="dv">2</span>, mean)</code></pre></div>
<pre><code>##   user.self    sys.self     elapsed  user.child   sys.child 
## 0.003714286 0.002571429 3.332285714 0.000000000 0.000000000</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time5, <span class="dv">2</span>, sd) <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(nrep)</code></pre></div>
<pre><code>##    user.self     sys.self      elapsed   user.child    sys.child 
## 0.0009184429 0.0009476071 0.0149582185 0.0000000000 0.0000000000</code></pre>
<p>We got the desired speedup. The elapsed time averages</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time5, <span class="dv">2</span>, mean)[<span class="st">&quot;elapsed&quot;</span>]</code></pre></div>
<pre><code>##  elapsed 
## 3.332286</code></pre>
<p>with parallelization and</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(time1, <span class="dv">2</span>, mean)[<span class="st">&quot;elapsed&quot;</span>]</code></pre></div>
<pre><code>##  elapsed 
## 9.870714</code></pre>
<p>without parallelization. But we did not get an 8-fold speedup with 8 cores. There is a cost to starting and stopping the child processes. And some time needs to be taken from this number crunching to run the rest of the computer. However, we did get a 3-fold speedup. If we had more cores, we could do even better.</p>
<p>We also that this method isn’t as good as the other method. So why do we want it (other than that the other doesn’t work on Windows)? Because it scales. You can get clusters with thousands of cores, but you can’t get thousands of cores in one computer.</p>
</div>
</div>
<div id="tear-down" class="section level3">
<h3><span class="header-section-number">3.6.5</span> Tear Down</h3>
<p>Don’t forget to tear down the cluster when you are done.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">stopCluster</span>(cl)</code></pre></div>
</div>
</div>
<div id="latis" class="section level2">
<h2><span class="header-section-number">3.7</span> LATIS</h2>
<div id="fork-exec-in-interactive-session" class="section level3">
<h3><span class="header-section-number">3.7.1</span> Fork-Exec in Interactive Session</h3>
<p>This is just like the fork-exec part of this document except for a few minor changes for running on LATIS.</p>
<p>SSH into <code>compute.cla.umn.edu</code>. Then</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">qsub</span> -I -l nodes=1:ppn=8
<span class="bu">cd</span> tmp/Orientation2018 <span class="co"># or wherever</span>
<span class="fu">wget</span> -N https://raw.githubusercontent.com/cjgeyer/Orientation2018/master/02-fork-exec.R
<span class="ex">module</span> load R/3.4.1
<span class="ex">R</span> CMD BATCH --vanilla 02-fork-exec.R
<span class="fu">cat</span> 02-fork-exec.Rout
<span class="bu">exit</span>
<span class="bu">exit</span></code></pre></div>
</div>
<div id="cluster-in-interactive-session" class="section level3">
<h3><span class="header-section-number">3.7.2</span> Cluster in Interactive Session</h3>
<p>Almost the same thing again</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">qsub</span> -I -l nodes=1:ppn=8
<span class="bu">cd</span> tmp/Orientation2018 <span class="co"># or wherever</span>
<span class="fu">wget</span> -N https://raw.githubusercontent.com/cjgeyer/Orientation2018/master/02-cluster.R
<span class="ex">module</span> load R/3.4.1
<span class="ex">R</span> CMD BATCH --vanilla 02-cluster.R
<span class="fu">cat</span> 02-cluster.Rout
<span class="bu">exit</span>
<span class="bu">exit</span></code></pre></div>
</div>
<div id="fork-exec-as-batch-job" class="section level3">
<h3><span class="header-section-number">3.7.3</span> Fork-Exec as Batch Job</h3>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> tmp/Orientation2018 <span class="co"># or wherever</span>
<span class="fu">wget</span> -N https://raw.githubusercontent.com/cjgeyer/Orientation2018/master/02-fork-exec.R
<span class="fu">wget</span> -N https://raw.githubusercontent.com/cjgeyer/Orientation2018/master/02-fork-exec.pbs
<span class="ex">qsub</span> 02-fork-exec.pbs</code></pre></div>
<p>If you want e-mail sent to you when the job starts and completes, then add the lines</p>
<pre><code>### EMAIL NOTIFICATION OPTIONS ###
#PBS -m abe                     # Send email on a:abort, b:begin, e:end
#PBS -M yourusername@umn.edu    # Your email address</code></pre>
<p>to <code>02-fork-exec.pbs</code> where, of course, <code>yourusername</code> is replaced by your actual username.</p>
<p>The linux command</p>
<pre><code>qstat</code></pre>
<p>will tell you if your job is running.</p>
<p>You can log out of <code>compute.cla.umn.edu</code> after your job starts in batch mode. It will keep running.</p>
</div>
<div id="cluster-as-batch-job" class="section level3">
<h3><span class="header-section-number">3.7.4</span> Cluster as Batch Job</h3>
<p>Same as above <a href="https://www.merriam-webster.com/dictionary/mutatis%20mutandis"><em>mutatis mutandis</em></a></p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">cd</span> tmp/Orientation2018 <span class="co"># or wherever</span>
<span class="fu">wget</span> -N https://raw.githubusercontent.com/cjgeyer/Orientation2018/master/02-cluster.R
<span class="fu">wget</span> -N https://raw.githubusercontent.com/cjgeyer/Orientation2018/master/02-cluster.pbs
<span class="ex">qsub</span> 02-cluster.pbs</code></pre></div>
<p>with the same comment about email.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="r-markdown.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="version-control-with-git.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"download": ["Orientation2018.pdf", "Orientation2018.epub"],
"toc": {
"collapse": "section",
"depth": 2,
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
